<!DOCTYPE html>
<html lang="en">

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>CSP and iframe Sandboxing | wizardsoftheweb</title>
    <link href="https://fonts.googleapis.com/css?family=Lato%7CRoboto+Mono" rel="stylesheet" />
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    <link href="//gitcdn.github.io/bootstrap-toggle/2.2.2/css/bootstrap-toggle.min.css" rel="stylesheet">
    <link href="https://maxcdn.bootstrapcdn.com/bootswatch/3.3.7/darkly/bootstrap.min.css" rel="stylesheet" integrity="sha384-S7YMK1xjUjSpEnF4P8hPUcgjXYLZKK3fQW1j5ObLSl787II9p8RO9XUGehRmKsxd" crossorigin="anonymous">
    <style>
    html,
    body {
        height: 100%;
        position: relative;
        font-size: 16px;
        font-family: "Lato", serif;
    }

    #main-nav {
        box-shadow: 0 10px 10px -5px rgba(55, 90, 127, 0.4);
    }

    #main-nav,
    #main-nav ul.nav>li {
        max-height: 60px;
        overflow-y: hidden;
    }

    #main-nav .scroll-spy-only {
        display: none;
    }

    body>article {
        margin-top: 70px;
    }

    body>article>*:not(:last-child)>*:nth-last-child(2) {
        margin-bottom: 20px;
    }

    body>* a>code {
        color: inherit;
    }

    body>* code {
        font-family: "Roboto Mono", monospace;
        padding: 0rem 0.4rem;
        color: #f8f8f2;
        background-color: #1b1d1e;
        border: 1px solid #505354;
    }

    header {
        margin-bottom: 20px;
    }

    article>* {
        min-height: 100vh;
        display: flex;
        flex-flow: column;
    }

    article>*>.scroll-spy-only {
        flex-grow: 1;
    }

    div.list-group {
        margin-bottom: 0;
    }

    #embed-here iframe {
        width: 100%;
        padding: 5px 15px;
        background-color: white;
        border: 3px solid black;
        min-height: 150px;
    }

    .opt-disabled {
        cursor: not-allowed;
    }

    th.disabled span {
        opacity: .65;
    }

    #sandbox-controls {
        display: flex;
        flex-flow: row;
        align-items: center;
        justify-content: center;
    }

    #sandbox-controls table {
        display: block;
        width: auto;
    }

    th:first-of-type {
        text-align: right;
    }

    td,
    th {
        text-align: center;
    }

    @media screen and (max-width: 991px) {
        #main-nav .navbar-header {
            float: none;
        }

        #main-nav .col-sm-12 {
            padding: 0;
        }

        #main-nav .container {
            width: 100%;
        }
    }

    @media (min-width: 801px) and (max-width: 991px) {
        #main-nav .col-sm-12 {
            display: flex;
            flex-flow: row;
            align-items: center;
            justify-content: center;
        }
    }

    @media screen and (max-width: 800px) {

        #main-nav .collapse.navbar-collapse {
            display: none !important;
        }

        #main-nav .collapse.navbar-collapse.in {
            display: block !important;
        }

        #main-nav ul.nav.navbar-nav li {
            float: none;
        }

        #main-nav .navbar-brand {
            margin-left: 0;
        }

        #main-nav .navbar-header .navbar-toggle {
            display: block;
        }
    }

    @media screen and (max-width: 420px) {
        #main-nav .shrink {
            display: none;
        }
    }

    </style>
</head>

<body data-spy="scroll" data-target="#main-nav" data-offset="60">
    <nav id="main-nav" class="navbar navbar-default navbar-fixed-top">
        <div class="container">
            <div class="row">
                <div class="col-sm-12">
                    <div class="navbar-header">
                        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navCollapse">
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                        </button>
                        <a class="navbar-brand" href="#"><code class="shrink">CSP|iframe</code> <code>sandbox</code> Comparison</a>
                    </div>
                    <div id="navCollapse" class="collapse navbar-collapse">
                        <ul class="nav navbar-nav">
                            <li class="scroll-spy-only nav-item"><a href="#top">Top</a>
                                <ul class="nav navbar-nav">
                                    <li class="scroll-spy-only nav-item"><a href="#end-top">Top Padding</a></li>
                                </ul>
                            </li>
                            <li class="nav-item"><a href="#privacy">Privacy</a>
                                <ul class="nav navbar-nav">
                                    <li class="scroll-spy-only nav-item"><a href="#end-privacy">Privacy Padding</a></li>
                                </ul>
                            </li>
                            <li class="nav-item"><a href="#overview">Overview</a>
                                <ul class="nav navbar-nav">
                                    <li class="scroll-spy-only nav-item"><a href="#end-overview">Overview Padding</a></li>
                                </ul>
                            </li>
                            <li class="nav-item"><a href="#sandbox-demo"><code>sandbox</code> Demo</a>
                                <ul class="nav navbar-nav">
                                    <li class="scroll-spy-only nav-item"><a href="#end-sandbox-demo"><code>sandbox</code> Demo Padding</a></li>
                                </ul>
                            </li>
                            <li class="nav-item"><a href="#other-stuff">Other Stuff</a>
                                <ul class="nav navbar-nav">
                                    <li class="scroll-spy-only nav-item"><a href="#end-other-stuff">Other Stuff Padding</a></li>
                                </ul>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </nav>
    <article class="container">
        <header class="row" id="top">
            <h1 class="col-md-12"><code>CSP</code> and <code>iframe</code> <code>sandbox</code> Comparison</h1>
            <div class="scroll-spy-only" id="end-header"></div>
        </header>
        <section class="row" id="privacy">
            <h2 class="col-md-12">Privacy</h2>
            <p class="col-md-12">
                If you've loaded this page on my website, <code>wizardsoftheweb.pro</code>, you should know that I'm actively tracking your usage via <a href="https://analytics.google.com/" target="_blank">Google Analytics</a>. Google collects <a href="https://www.google.com/policies/privacy/#infocollect" target="_blank">quite a bit of information</a> which is then <a href="https://www.google.com/policies/privacy/#infouse" target="_blank">shared across Google apps</a>, including Google Analytics.
            </p>
            <p class="col-md-12">
                As far as I know, Google Analytics does not respect <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/DNT" target="_blank">the Do Not Track header</a>. To opt out on my site, install the relevant <a href="https://tools.google.com/dlpage/gaoptout" target="_blank">Google Analytics Opt-out Browser Add-on</a>. I also highly recommend reading <a href="https://www.eff.org/issues/do-not-track" target="_blank">EFF's DNT overview</a> and installing <a href="https://www.eff.org/privacybadger" target="_blank">EFF's Privacy Badger</a>.
            </p>
            <p class="col-md-12">
                If you're cool with me (and by extension Google) tracking your usage, I really appreciate it. I'm curious about how you interact with my content and eventually want to play with the data. So you know, I'm monitoring these events:
            </p>
            <div class="col-md-12">
                <div class="list-group">
                    <a href="https://support.google.com/tagmanager/answer/6106961?hl=en#Pageview" target="gtmhelp" class="list-group-item">Page views</a>
                    <a href="https://support.google.com/tagmanager/answer/6106961?hl=en#scroll" target="gtmhelp" class="list-group-item">Scroll depth</a>
                    <a href="https://support.google.com/tagmanager/answer/6106961?hl=en#Click" target="gtmhelp" class="list-group-item">Clicks on <code>.btn</code>s and <code>a</code>nchors (links)</a>
                    <a href="https://support.google.com/tagmanager/answer/6106961?hl=en#HistoryChange" target="gtmhelp" class="list-group-item">History changes</a>
                </div>
            </div>
            <div class="scroll-spy-only" id="end-privacy"></div>
        </section>
        <section class="row" id="overview">
            <h2 class="col-md-12">Overview</h2>
            <p class="col-md-12">
                This page attempts to illustrate how <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Security-Policy/sandbox" target="_blank"><code>Content-Security-Policy</code> <code>sandbox</code> headers</a> and <a href="https://developer.mozilla.org/en-US/docs/Web/HTML/Element/iframe#attr-sandbox" target="_blank"><code>iframe</code> <code>sandbox</code> attributes</a> interact. I couldn't find any practical examples and wasn't sure how this would actually turn out, so I built this. <strong>tl;dr:</strong> always set the <code>iframe</code> attribute; also set the <code>CSP</code> header when you can.
            </p>
            <p class="col-md-12">
                Using the switches below, you can change the <code>CSP</code> header and the <code>iframe</code> attribute. <a href="//github.com/wizardsoftheweb/csp-iframe-sandbox-comparison/blob/master/embed-me.php" target="_blank">The external file, <code>embed-me.php</code></a>, is a simple PHP script that creates a <code>CSP</code> header from <code>$_GET</code> params and serves a very basic HTML page with some JavaScript.
            </p>
            <p class="col-md-12">
                I didn't actually implement very many <code>sandbox</code> options. If there's something you'd like to see tested, shoot me an email (<code>cj@</code> this website) or check out <a href="//github.com/wizardsoftheweb/csp-iframe-sandbox-comparison" target="_blank">the repo</a> and make a PR or a fork.
            </p>
            <p class="col-md-12">
                <strong>WARNING:</strong> disabling both <code>sandbox</code>es or turning on <code>allow-modals</code> triggers a vanilla <code>alert</code>. <code>alert</code>s are supremely annoying and should never be used unless you're trying to illustrate specific behavior (or you need a quick way to leave content live but make sure no one uses it more than once).
            </p>
            <div class="scroll-spy-only" id="end-overview"></div>
        </section>
        <section class="row" id="sandbox-demo">
            <h2 class="col-md-12"><code>sandbox</code> demo</h2>
            <div class="col-md-12" id="sandbox-controls">
                <table class="table table-responsive">
                    <thead>
                        <tr>
                            <th>Source</th>
                            <th><code>sandbox</code></th>
                            <th><code>allow-scripts</code></th>
                            <th><code>allow-modals</code></th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr id="csp-controls" data-toggle="tooltip">
                            <th><span><code>Content-Security-Policy</code> header</span></th>
                            <td class="always-enabled">
                                <input id="csp-sandbox" type="checkbox" data-toggle="toggle" data-onstyle="success" data-offstyle="danger" checked>
                            </td>
                            <td>
                                <input id="csp-allow-scripts" type="checkbox" data-toggle="toggle" data-onstyle="success" data-offstyle="danger">
                            </td>
                            <td data-toggle="tooltip">
                                <input id="csp-allow-modals" type="checkbox" data-toggle="toggle" data-onstyle="success" data-offstyle="danger" disabled>
                            </td>
                            <td class="always-enabled">
                                <button class="btn btn-primary">Reset</button>
                            </td>
                        </tr>
                        <tr id="iframe-controls" data-toggle="tooltip">
                            <th>
                                <span><code>iframe</code> attribute</span>
                            </th>
                            <td class="always-enabled">
                                <input id="iframe-sandbox" type="checkbox" data-toggle="toggle" data-onstyle="success" data-offstyle="danger" checked>
                            </td>
                            <td data-toggle="tooltip">
                                <input id="iframe-allow-scripts" type="checkbox" data-toggle="toggle" data-onstyle="success" data-offstyle="danger">
                            </td>
                            <td data-toggle="tooltip">
                                <input id="iframe-allow-modals" type="checkbox" data-toggle="toggle" data-onstyle="success" data-offstyle="danger" disabled>
                            </td>
                            <td class="always-enabled">
                                <button class="btn btn-primary">Reset</button>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div class="col-md-8 col-md-push-2 col-sm-12" id="embed-here">
            </div>
            <div class="scroll-spy-only" id="end-sandbox-demo"></div>
        </section>
        <footer class="row" id="other-stuff">
            <h2 class="col-md-12">Other Stuff</h2>
            <p class="col-md-12">
                I wrote about this on my blog (jk not yet; update when I do).
            </p>
            <p class="col-md-12">
                This page falls under <a href="//github.com/wizardsoftheweb/csp-iframe-sandbox-comparison/blob/master/LICENSE" target="_blank">the source's ISC license</a>.
            </p>
            <p class="col-md-12">
                This demo makes use of the following tools (plus lots of <a href="https://stackoverflow.com" target="_blank">Stack Overflow</a> and probably some stuff I forgot to explicitly mention):
            </p>
            <div class="col-md-12">
                <div class="list-group">
                    <a href="//jquery.com/" target="_blank" class="list-group-item">jQuery</a>
                    <a href="//getbootstrap.com" target="_blank" class="list-group-item">Bootstrap</a>
                    <a href="//bootswatch.com/darkly/" target="_blank" class="list-group-item">Bootswatch's Darkly (with some local modifications)</a>
                    <a href="//www.bootstraptoggle.com" target="_blank" class="list-group-item">Bootstrap Toggle</a>
                    <a href="//fonts.google.com/specimen/Lato" target="_blank" class="list-group-item">Lato via Google Fonts</a>
                    <a href="//fonts.google.com/specimen/Roboto+Mono" target="_blank" class="list-group-item"><code>Roboto Mono</code> via Google Fonts</a>
                </div>
            </div>
        </footer>
    </article>
    <script src="https://code.jquery.com/jquery-3.2.1.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
    <script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
    <script src="//gitcdn.github.io/bootstrap-toggle/2.2.2/js/bootstrap-toggle.min.js"></script>
    <script>
    const EMBED_CONTAINER = $("#embed-here");
    const SANDBOX_CONTROLS = $("#sandbox-controls");
    const OPTION_STATE = {
        csp: {
            controls: $("#csp-controls"),
            sandbox: $("#csp-sandbox"),
            scripts: $("#csp-allow-scripts"),
            modals: $("#csp-allow-modals"),
        },
        iframe: {
            controls: $("#iframe-controls"),
            sandbox: $("#iframe-sandbox"),
            scripts: $("#iframe-allow-scripts"),
            modals: $("#iframe-allow-modals"),
        },
    };
    const MAIN_NAV = $("#main-nav");
    const NAV_PRECEDENCE = [""];
    const SCROLL_SPY_SHIFT_REDUCTION = 10;

    let MAIN_NAV_HEIGHT_CONTRIBUTION;
    let SCROLL_SPY_SHIFT;
    let LAST_EVENT_TIMESTAMP;


    $(document).ready(function() {
        MAIN_NAV
            .find("li>a[href^='#']:not([href^='#end'])")
            .each(function() {
                let hash = $.attr(this, "href");
                NAV_PRECEDENCE[hash] = NAV_PRECEDENCE.length;
                NAV_PRECEDENCE.push(hash);
            });

        MAIN_NAV_HEIGHT_CONTRIBUTION = Math.min(
            parseInt(MAIN_NAV.css("max-height")),
            MAIN_NAV.height()
        );

        SCROLL_SPY_SHIFT = Math.max(
            MAIN_NAV_HEIGHT_CONTRIBUTION,
            $("body").data().offset - SCROLL_SPY_SHIFT_REDUCTION,
        );

        // @todo: write-up around this answer
        // https://stackoverflow.com/a/23084780/2877698
        // https://caniuse.com/#search=replaceState
        // https://developer.mozilla.org/en-US/docs/Web/API/History_API#The_replaceState%28%29_method
        $(window).on('activate.bs.scrollspy', function(event) {
            const currentHref = location.href;
            const storedHash = location.hash;
            const currentHash = $("a[href^='#']", event.target)
                .attr("href")
                .replace("#top", "");
            history.replaceState({},
                "",
                currentHref.replace(storedHash, "") + currentHash
            );
        });

        $("a[href^='#']").not("a[href='#']").click(function(event) {
            const target = $($.attr(this, "href"));
            if (target) {
                event.preventDefault();
                $("html, body").animate({
                        scrollTop: target.offset().top - SCROLL_SPY_SHIFT
                    },
                    300,
                    function() {
                        target.focus();
                    },
                );
            }
        });

        rebuildAllControlStates();

        reloadEmbed();

        SANDBOX_CONTROLS.find("input[type='checkbox']").change(function() {
            reloadEmbed();
        });

        SANDBOX_CONTROLS.find("td > button.btn.btn-primary").click(function() {
            let owningRow = $(this).closest("tr");
            owningRow.find("input[id$='sandbox']").bootstrapToggle("on");
            owningRow.find("input[id*='-allow-']").each(function() {
                $(this)
                    .bootstrapToggle("enable")
                    .bootstrapToggle("off");
            });
            reloadEmbed();
        });
    });

    function reloadEmbed() {
        EMBED_CONTAINER.find("iframe").remove();
        let embed = $("<iframe />");
        let source = "embed-me.php";
        let cspSandboxed = OPTION_STATE.csp.sandbox.is(":checked");
        if (cspSandboxed) {
            source += "?sandbox="
            if (OPTION_STATE.csp.scripts.is(":checked")) {
                if (OPTION_STATE.csp.modals.is(":checked")) {
                    source += "modals";
                } else {
                    source += "scripts";
                }
            } else {
                source += "on";
            }
        }
        embed.attr("src", source);
        let iframeSandboxed = OPTION_STATE.iframe.sandbox.is(":checked");
        if (iframeSandboxed) {
            let options = [];
            if (OPTION_STATE.iframe.scripts.is(":checked")) {
                options.push("allow-scripts");
                if (OPTION_STATE.iframe.modals.is(":checked")) {
                    options.push("allow-modals");
                }
            }
            if (options) {
                embed.attr("sandbox", options.join(" "));
            }
        }
        EMBED_CONTAINER.append(embed);
        rebuildAllControlStates(cspSandboxed, iframeSandboxed);
    }

    function rebuildAllControlStates(cspSandboxed = true, iframeSandboxed = true) {
        rebuildSingleControlState("csp", cspSandboxed);
        rebuildSingleControlState("iframe", iframeSandboxed);
    }

    function rebuildSingleControlState(source, sandboxed = true) {
        OPTION_STATE[source].controls.toggleClass("danger", !sandboxed);
        OPTION_STATE[source].controls.find("th, td:not(.always-enabled) .btn").toggleClass("disabled", !sandboxed);
        toggleToggleInteraction(OPTION_STATE[source].scripts, !sandboxed);
        rebuildSingleModalState(source, !sandboxed || !OPTION_STATE[source].scripts.is(":checked"));
        if (sandboxed) {
            OPTION_STATE[source].controls.tooltip("destroy");
        } else {
            OPTION_STATE[source].controls.find("td, th").tooltip("destroy");
            OPTION_STATE[source].controls.tooltip({
                title: `The ${source} sandbox is not currently enabled`
            });
        }
    }

    function toggleToggleInteraction(toggleElement, disabled = true) {
        toggleElement.bootstrapToggle(disabled ? "disable" : "enable");
        toggleElement.parent().find(".btn").toggleClass("disabled", disabled);
    }

    function rebuildSingleModalState(source, scriptsDisabled = true) {
        toggleToggleInteraction(OPTION_STATE[source].modals, scriptsDisabled);
        OPTION_STATE[source].modals.closest("td")
            .toggleClass("opt-disabled", scriptsDisabled)
            .tooltip(
                scriptsDisabled ? {
                    title: "<code>allow-scripts</code> must be enabled",
                    html: true,
                    container: "#sandbox-controls",
                } :
                "destroy"
            );
    }

    </script>
</body>

</html>
